import type { Database } from 'better-sqlite3';
import { EOL } from 'os';

export type DynamicQuery08DynamicParams = {
	select?: DynamicQuery08Select;
	params?: DynamicQuery08Params;
	where?: DynamicQuery08Where[];
}

export type DynamicQuery08Params = {
	param1?: Date | null;
	param2?: Date | null;
}

export type DynamicQuery08Result = {
	text_column?: string;
	date?: Date;
	date_time?: Date;
}

export type DynamicQuery08Select = {
	text_column?: boolean;
	date?: boolean;
	date_time?: boolean;
}

const selectFragments = {
	text_column: `text_column`,
	date: `date(text_column)`,
	date_time: `datetime(text_column)`,
} as const;

const NumericOperatorList = ['=', '<>', '>', '<', '>=', '<='] as const;
type NumericOperator = typeof NumericOperatorList[number];
type StringOperator = '=' | '<>' | '>' | '<' | '>=' | '<=' | 'LIKE';
type SetOperator = 'IN' | 'NOT IN';
type BetweenOperator = 'BETWEEN';

export type DynamicQuery08Where =
	| { column: 'text_column'; op: StringOperator; value: string | null }
	| { column: 'text_column'; op: SetOperator; value: string[] }
	| { column: 'text_column'; op: BetweenOperator; value: [string | null, string | null] }
	| { column: 'date'; op: NumericOperator; value: Date | null }
	| { column: 'date'; op: SetOperator; value: Date[] }
	| { column: 'date'; op: BetweenOperator; value: [Date | null, Date | null] }
	| { column: 'date_time'; op: NumericOperator; value: Date | null }
	| { column: 'date_time'; op: SetOperator; value: Date[] }
	| { column: 'date_time'; op: BetweenOperator; value: [Date | null, Date | null] }

export function dynamicQuery08(db: Database, params?: DynamicQuery08DynamicParams): DynamicQuery08Result[] {
	const paramsValues: any = [];
	const whereColumns = new Set(params?.where?.map(w => w.column) || []);
	let sql = 'SELECT';
	if (params?.select == null || params.select.text_column) {
		sql = appendSelect(sql, `text_column`);
	}
	if (params?.select == null || params.select.date) {
		sql = appendSelect(sql, `date(text_column) as date`);
	}
	if (params?.select == null || params.select.date_time) {
		sql = appendSelect(sql, `datetime(text_column) as date_time`);
	}
	sql += EOL + `FROM all_types`;
	sql += EOL + `WHERE 1 = 1`;
	sql += EOL + `AND date(text_column) = ? AND datetime(text_column) = ?`;
	paramsValues.push(params?.params?.param1?.toISOString().split('T')[0] ?? null);
	paramsValues.push(params?.params?.param2?.toISOString().split('.')[0].replace('T', ' ') ?? null);
	params?.where?.forEach(condition => {
		const where = whereCondition(condition, () => '?');
		if (where?.hasValue) {
			sql += EOL + 'AND ' + where.sql;
			paramsValues.push(...where.values);
		}
	});
	return db.prepare(sql)
		.raw(true)
		.all(paramsValues)
		.map(data => mapArrayToDynamicQuery08Result(data, params?.select));
}

function mapArrayToDynamicQuery08Result(data: any, select?: DynamicQuery08Select) {
	const result = {} as DynamicQuery08Result;
	let rowIndex = -1;
	if (select == null || select.text_column) {
		rowIndex++;
		result.text_column = data[rowIndex];
	}
	if (select == null || select.date) {
		rowIndex++;
		result.date = data[rowIndex] != null ? new Date(data[rowIndex]) : data[rowIndex];
	}
	if (select == null || select.date_time) {
		rowIndex++;
		result.date_time = data[rowIndex] != null ? new Date(data[rowIndex]) : data[rowIndex];
	}
	return result;
}

function appendSelect(sql: string, selectField: string) {
	if (sql.toUpperCase().endsWith('SELECT')) {
		return sql + EOL + selectField;
	}
	else {
		return sql + ', ' + EOL + selectField;
	}
}

type WhereConditionResult = {
	sql: string;
	hasValue: boolean;
	values: any[];
}

function whereCondition(condition: DynamicQuery08Where, placeholder: () => string): WhereConditionResult | null {
	const selectFragment = selectFragments[condition.column];
	const { op, value } = condition;

	if (op === 'LIKE') {
		return {
			sql: `${selectFragment} LIKE ${placeholder()}`,
			hasValue: value != null,
			values: [value]
		}
	}
	if (op === 'BETWEEN') {
		const [from, to] = Array.isArray(value) ? value : [null, null];
		return {
			sql: `${selectFragment} BETWEEN ${placeholder()} AND ${placeholder()}`,
			hasValue: from != null && to != null,
			values: [from, to]
		}
	}
	if (op === 'IN' || op === 'NOT IN') {
		if (!Array.isArray(value) || value.length === 0) {
			return { sql: '', hasValue: false, values: [] };
		}
		return {
			sql: `${selectFragment} ${op} (${value.map(() => placeholder()).join(', ')})`,
			hasValue: true,
			values: value
		}
	}
	if (NumericOperatorList.includes(op)) {
		return {
			sql: `${selectFragment} ${op} ${placeholder()}`,
			hasValue: value != null,
			values: [value]
		}
	}
	return null;
}

function isDate(value: any): value is Date {
	return value instanceof Date;
}